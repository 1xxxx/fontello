/*global window, nodeca*/

//= require EventEmitter

//= require_self
//= require_tree ./nodeca


var nodeca = window.nodeca = (function (nodeca) {
  'use strict';

  nodeca.emit = nodeca.trigger;
  nodeca.once = function (evt, listener) {
    var self = this, kamikaze;

    kamikaze = function () {
      self.off(evt, kamikaze);
      return listener.apply(this, arguments);
    };

    this.on(evt, kamikaze);
  };

  nodeca.config           = {};
  nodeca.config.app       = <%- JSON.stringify(nodeca('config.app')) %>
  nodeca.views            = {};
  nodeca.server           = {};
  nodeca.shared           = {};
  nodeca.client           = {};

  nodeca.runtime          = {};
  nodeca.runtime.env      = "<%= nodeca('runtime.env') %>";
  nodeca.runtime.version  = "<%= nodeca('runtime.version') %>";
  nodeca.runtime.locale   = "en-US";
  nodeca.runtime.i18n     = new BabelFish({});

  // translations injector
  nodeca.runtime.i18n.load = function loadTranslations(lang, data) {
    if (undefined === nodeca.runtime.i18n._storage[lang]) {
      nodeca.runtime.i18n._storage[lang] = {};
    }

    $.extend(nodeca.runtime.i18n._storage[lang], data);
  };

  // translation helper with active locale
  nodeca.runtime.t        = function (phrase, params) {
    return nodeca.runtime.i18n.t(nodeca.runtime.locale, phrase, params);
  };

  nodeca.runtime.t.exists = function (phrase) {
    return nodeca.runtime.i18n.hasPhrase(nodeca.runtime.locale, phrase);
  };

  // Create cross-browser log wrapper
  //
  (function () {
    var dumb;

    if (!window.console.log) {
      dumb = $.noop;
    } else {
      dumb = function (a, b, c, d, e) {
        try {
          window.console.log(a, b, c, d, e);
        } catch (e) {
          // do nothing
        }
      };
    }

    nodeca.logger = {};

    _.each(['assert', 'error', 'info', 'warn', 'debug'], function (level) {
      if (!window.console[level]) {
        nodeca.logger[level] = dumb;
      } else {
        nodeca.logger[level] = function (a, b, c, d, e) {
          try {
            window.console[level](a, b, c, d, e);
          } catch (e) {
            // do nothing
          }
        };
      }
    });
  }());


  return nodeca;
}(new EventEmitter));

// vim: syntax=javascript
