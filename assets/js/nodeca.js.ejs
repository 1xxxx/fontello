/*global window*/

(function () {
  'use strict';


  var nodeca = window.nodeca = {
    runtime: {
      env:     "<%= env() %>",
      version: "<%= version() %>"
    }
  };

  <% if ('development' === env()) { %>
    nodeca.logger = console;
    nodeca.logger = {
      assert : console.assert || console.debug || console.log,
      error  : console.error || console.log,
      info   : console.info || console.log,
      notice : console.notice || console.info || console.log,
      debug  : console.debug || console.log
    };
  <% } else { %>
    nodeca.logger = {
      assert : $.noop,
      error  : $.noop,
      info   : $.noop,
      notice : $.noop,
      debug  : $.noop
    };
  <% } %>

  (function (sio) {
    nodeca.runtime.rpc = function (name, params, callback) {
      var msg = {
        version:  nodeca.runtime.version,
        method:   name,
        params:   params
      };

      sio.emit('server', msg, function (res) {
        if (res.version !== nodeca.runtime.version) {
          // TODO: implement software upgrade here
          console.alert('nodeca server version mismatch');
          return;
        }

        (callback || $.noop)(res.err, res.result);
      });
    };
  }(io.connect()));
}());
